<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Jarvis TTS Console</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        background-color: #121212;
        color: #e0e0e0;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 10px;
      }

      #view {
        background-color: #1e1e1e;
        padding: 20px 22px;
        border-radius: 10px;
        box-shadow: 0 0 20px rgba(0, 188, 212, 0.35);
        max-width: 720px;
        width: 100%;
      }

      h3 {
        color: #00bcd4;
        margin-bottom: 10px;
        font-size: 22px;
        font-weight: 500;
        text-align: center;
      }

      .subtitle {
        text-align: center;
        font-size: 13px;
        color: #aaa;
        margin-bottom: 16px;
      }

      textarea#text {
        width: 100%;
        padding: 10px;
        margin: 8px 0 10px 0;
        border: 1px solid #333;
        border-radius: 6px;
        background-color: #2a2a2a;
        color: #e0e0e0;
        font-size: 15px;
        line-height: 1.4;
        resize: vertical;
        min-height: 110px;
        max-height: 260px;
      }

      textarea#text::placeholder {
        color: #777;
      }

      #displayText {
        margin-top: 8px;
        padding: 10px;
        border-radius: 6px;
        background-color: #181818;
        border: 1px solid #333;
        font-size: 15px;
        line-height: 1.4;
        white-space: pre-wrap;
        min-height: 60px;
      }

      .highlight-word {
        background-color: #00bcd4;
        color: #121212;
        border-radius: 3px;
        padding: 0 2px;
      }

      .row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 8px;
        align-items: center;
      }

      .row label {
        font-size: 13px;
        color: #ccc;
      }

      select,
      input[type="range"] {
        flex: 1;
      }

      select {
        padding: 6px;
        border-radius: 6px;
        border: 1px solid #333;
        background-color: #2a2a2a;
        color: #e0e0e0;
        font-size: 13px;
      }

      input[type="range"] {
        accent-color: #00bcd4;
      }

      .range-value {
        min-width: 32px;
        text-align: right;
        font-size: 12px;
        color: #aaa;
      }

      .buttons {
        margin-top: 12px;
        display: flex;
        gap: 8px;
        justify-content: center;
        flex-wrap: wrap;
      }

      button {
        background-color: #00bcd4;
        color: #121212;
        padding: 9px 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.8px;
        transition: background-color 0.25s ease, box-shadow 0.25s ease,
          transform 0.15s ease;
      }

      button:hover:not(:disabled) {
        background-color: #0097a7;
        box-shadow: 0 0 12px rgba(0, 188, 212, 0.5);
        transform: translateY(-1px);
      }

      button:focus,
      button:focus-visible {
        outline: none;
        box-shadow: 0 0 0 2px rgba(0, 188, 212, 0.35);
        background-color: #00bcd4;
      }

      button:active:not(:disabled) {
        transform: translateY(0);
      }

      button:disabled {
        background-color: #555;
        color: #888;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
      }

      #status {
        margin-top: 10px;
        font-size: 13px;
        text-align: center;
        color: #00bcd4;
      }

      #charCount {
        font-size: 12px;
        color: #aaa;
        margin-top: 4px;
        text-align: right;
      }

      .hint {
        font-size: 11px;
        color: #777;
        text-align: center;
        margin-top: 8px;
      }

      hr {
        border: 0;
        border-top: 1px solid #333;
        margin: 12px 0;
      }

      @media (max-width: 600px) {
        #view {
          padding: 16px;
        }
      }
    </style>
  </head>

  <body>
    <div id="view">
      <h3>Jarvis TTS Console</h3>
      <div class="subtitle">
        Type text and let your browser speak it. Python can control this window
        too.
      </div>

      <textarea
        id="text"
        rows="8"
        maxlength="10000000"
        placeholder="Enter text here or let Jarvis fill this from Python..."
      ></textarea>

      <div id="charCount">Characters: 0</div>

      <!-- Live display of text with current spoken word highlighted -->
      <div id="displayText"></div>

      <hr />

      <div class="row">
        <label for="voiceSelect">Voice:</label>
        <div
          id="voiceName"
          style="
            flex: 1;
            font-size: 13px;
            color: #e0e0e0;
            padding: 6px 8px;
            border: 1px solid #333;
            border-radius: 6px;
            background-color: #2a2a2a;
          "
        >
          Loading voice...
        </div>
      </div>

      <div class="row">
        <label for="rateRange">Rate:</label>
        <input
          type="range"
          id="rateRange"
          min="0.5"
          max="2"
          step="0.1"
          value="1"
        />
        <span class="range-value" id="rateValue">1.0x</span>
      </div>

      <div class="row">
        <label for="pitchRange">Pitch:</label>
        <input
          type="range"
          id="pitchRange"
          min="0"
          max="2"
          step="0.1"
          value="1"
        />
        <span class="range-value" id="pitchValue">1.0</span>
      </div>

      <div class="row">
        <label for="volumeRange">Volume:</label>
        <input
          type="range"
          id="volumeRange"
          min="0"
          max="1"
          step="0.05"
          value="1"
        />
        <span class="range-value" id="volumeValue">100%</span>
      </div>

      <div class="buttons">
        <!-- main play button (Python clicks this via Selenium id="button") -->
        <button type="button" id="button">Speak â–¶</button>
      </div>

      <div id="status">Status: Idle</div>
      <div class="hint">Shortcut: <b>Ctrl + Enter</b> to speak.</div>
    </div>

    <script>
      let voices = [];
      let currentUtterance = null;
      let originalText = "";

      function pickDefaultVoiceIndex() {
        if (!voices || voices.length === 0) return 0;
        const markIdx = voices.findIndex((v) =>
          (v?.name || "").toLowerCase().includes("mark")
        );
        if (markIdx >= 0) return markIdx;
        const defaultIdx = voices.findIndex((v) => v?.default);
        return defaultIdx >= 0 ? defaultIdx : 0;
      }

      function updateCharCount() {
        const len = document.getElementById("text").value.length;
        document.getElementById("charCount").innerText = "Characters: " + len;
      }

      function escapeHtml(str) {
        return str
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");
      }

      // Sync textarea content to the display box (no highlight)
      function syncDisplayToTextarea() {
        const t = document.getElementById("text").value;
        originalText = t;
        const display = document.getElementById("displayText");
        display.textContent = t;
      }

      // Highlight the current spoken word based on charIndex
      function updateDisplayHighlight(charIndex) {
        const text = originalText || "";
        const display = document.getElementById("displayText");

        if (!text) {
          display.textContent = "";
          return;
        }

        let start = charIndex;
        while (start > 0 && !/\s/.test(text[start - 1])) {
          start--;
        }

        let end = charIndex;
        while (end < text.length && !/\s/.test(text[end])) {
          end++;
        }

        const before = text.slice(0, start);
        const word = text.slice(start, end);
        const after = text.slice(end);

        display.innerHTML =
          escapeHtml(before) +
          '<span class="highlight-word">' +
          escapeHtml(word) +
          "</span>" +
          escapeHtml(after);
      }

      function populateVoices() {
        if (!("speechSynthesis" in window)) {
          document.getElementById("status").innerText =
            "Status: Web Speech API not supported in this browser.";
          document.getElementById("button").disabled = true;
          return;
        }

        const allVoices = window.speechSynthesis.getVoices();
        const markVoice = allVoices.find((v) =>
          (v?.name || "").toLowerCase().includes("mark")
        );
        const fallbackVoice = allVoices[0];

        voices = [];
        if (markVoice) {
          voices.push(markVoice);
        } else if (fallbackVoice) {
          voices.push(fallbackVoice);
        }

        const voiceName = document.getElementById("voiceName");
        if (voices.length === 0) {
          voiceName.innerText = "No voices available";
        } else {
          const voice = voices[0];
          voiceName.innerText = `${voice.name} (${voice.lang})`;
        }
      }

      function speak() {
        const textArea = document.getElementById("text");
        const rawText = textArea.value;
        const text = rawText.trim();

        if (!text) {
          alert("Please enter some text first.");
          return;
        }

        if (!("speechSynthesis" in window)) {
          alert("Speech Synthesis not supported in this browser.");
          return;
        }

        // Use trimmed text for both display + speech for consistent charIndex
        originalText = text;
        const display = document.getElementById("displayText");
        display.textContent = text;

        // Cancel any ongoing speech first
        window.speechSynthesis.cancel();
        currentUtterance = new SpeechSynthesisUtterance(text);

        const rate = parseFloat(
          document.getElementById("rateRange").value || "1"
        );
        const pitch = parseFloat(
          document.getElementById("pitchRange").value || "1"
        );
        const volume = parseFloat(
          document.getElementById("volumeRange").value || "1"
        );
        currentUtterance.rate = rate;
        currentUtterance.pitch = pitch;
        currentUtterance.volume = volume;

        if (voices[0]) {
          currentUtterance.voice = voices[0];
        }

        const statusEl = document.getElementById("status");
        const speakBtn = document.getElementById("button");

        speakBtn.disabled = true;
        statusEl.innerText = "Status: Speaking...";

        currentUtterance.onstart = () => {
          statusEl.innerText = "Status: Speaking...";
        };

        currentUtterance.onend = () => {
          statusEl.innerText = "Status: Finished.";
          speakBtn.disabled = false;
          // Reset display to plain text (no highlight)
          const display = document.getElementById("displayText");
          display.textContent = originalText;
        };

        currentUtterance.onerror = (e) => {
          statusEl.innerText = "Status: Error during speech.";
          console.error("Speech error:", e);
          speakBtn.disabled = false;
          const display = document.getElementById("displayText");
          display.textContent = originalText;
        };

        // MAIN PART: update current spoken word
        currentUtterance.onboundary = (event) => {
          if (typeof event.charIndex === "number") {
            updateDisplayHighlight(event.charIndex);
          }
        };

        window.speechSynthesis.speak(currentUtterance);
      }

      function stopSpeech() {
        if ("speechSynthesis" in window) {
          window.speechSynthesis.cancel();
        }
        document.getElementById("status").innerText = "Status: Stopped.";
        document.getElementById("button").disabled = false;
        // Reset highlight
        const display = document.getElementById("displayText");
        display.textContent = originalText;
      }

      // Events
      document.getElementById("button").onclick = speak;

      document.getElementById("text").oninput = function () {
        updateCharCount();
        syncDisplayToTextarea();
      };

      document.getElementById("text").onkeydown = function (e) {
        // Ctrl/Cmd + Enter => Speak
        if (
          (e.key === "Enter" || e.keyCode === 13) &&
          (e.ctrlKey || e.metaKey)
        ) {
          e.preventDefault();
          const speakBtn = document.getElementById("button");
          if (!speakBtn.disabled) {
            speak();
          }
        }
        // Esc => Stop
        if (e.key === "Escape" || e.keyCode === 27) {
          stopSpeech();
        }
      };

      // Rate, pitch, volume live value display
      document.getElementById("rateRange").oninput = function () {
        document.getElementById("rateValue").innerText = this.value + "x";
      };
      document.getElementById("pitchRange").oninput = function () {
        document.getElementById("pitchValue").innerText = this.value;
      };
      document.getElementById("volumeRange").oninput = function () {
        document.getElementById("volumeValue").innerText =
          Math.round(this.value * 100) + "%";
      };

      // Voices may load asynchronously
      if (typeof speechSynthesis !== "undefined") {
        speechSynthesis.onvoiceschanged = populateVoices;
        populateVoices();
      } else {
        document.getElementById("status").innerText =
          "Status: Speech Synthesis not supported.";
      }

      // Initial char count + display sync
      updateCharCount();
      syncDisplayToTextarea();
    </script>
  </body>
</html>
